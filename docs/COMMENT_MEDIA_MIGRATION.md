# Добавление медиа поддержки в комментарии

## Что сделано

Добавлена возможность прикреплять фотографии и голосовые сообщения к комментариям.

### 1. База данных
- Создана миграция `009_add_comment_media_support.sql`
- Добавлены поля `media_urls` (массив URL изображений) и `audio_url` (URL аудио)
- Создан отдельный bucket `comment-images` в Supabase Storage
- Настроены политики доступа

### 2. Компоненты

#### CommentForm
- Добавлены кнопки для загрузки фото и записи голосовых сообщений
- Интеграция с `ImageUploader` и `VoiceRecorder`
- Ограничение: до 3 изображений или 1 голосовое сообщение
- Превью загруженных медиа перед отправкой

#### CommentItem
- Отображение изображений через `MediaGallery` (compact mode)
- Отображение аудио через `AudioPlayerCompact`
- Сохранена эстетика комментариев

#### CommentSection
- Обновлены запросы для загрузки медиа полей

## Как применить миграцию

### Вариант 1: Через Supabase CLI
```bash
supabase db push
```

### Вариант 2: Через Supabase Dashboard
1. Откройте ваш проект в Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте содержимое файла `supabase/migrations/009_add_comment_media_support.sql`
4. Вставьте и выполните запрос

### Вариант 3: Вручную через SQL
```sql
-- Выполните содержимое migration файла в SQL Editor
```

## Использование

### Для пользователей
1. **Добавить фото**: Нажмите кнопку с иконкой изображения в форме комментария
2. **Записать голос**: Нажмите кнопку с иконкой микрофона
3. **Ограничения**:
   - Максимум 3 изображения на комментарий
   - Нельзя прикрепить и фото, и аудио одновременно
   - Минимальная длина комментария: 3 символа

### Эстетика
- Изображения отображаются в компактном режиме
- Hover эффекты включены для лучшего UX
- Аудиоплеер компактный и не занимает много места
- Всё соответствует общему дизайну комментариев

## Технические детали

### Storage
- Bucket: `comment-images`
- Политики: публичное чтение, авторизованная загрузка, удаление своих файлов
- Структура путей:
  - Изображения: `{user-id}/{filename}.jpg`
  - Аудио: `{user-id}/voice-{timestamp}.webm`

### Структура БД
```sql
ALTER TABLE comments ADD COLUMN media_urls TEXT[];
ALTER TABLE comments ADD COLUMN audio_url TEXT;
```

### Индексы
- GIN индекс на `media_urls` для быстрого поиска
- Обычный индекс на `audio_url` для фильтрации

### Важные исправления
1. **Путь к файлам** - используется `user.id` в пути для соответствия Storage политикам
2. **Content-Type** - для аудио явно указывается `audio/webm`
3. **Отладка** - добавлены console.log для отслеживания загрузки и ошибок воспроизведения

## Что дальше

Рекомендуется добавить:
1. Ограничение на размер файлов (через Storage policies)
2. Автоматическое сжатие изображений
3. Валидацию форматов файлов на backend
4. Возможность редактирования комментариев с медиа
