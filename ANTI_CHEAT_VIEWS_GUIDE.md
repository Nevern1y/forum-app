# üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ—Å—Ç–æ–≤ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –ö–∞–∂–¥—ã–π –≤—Ö–æ–¥ –Ω–∞ –ø–æ—Å—Ç —É–≤–µ–ª–∏—á–∏–≤–∞–ª —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –Ω–∞–∫—Ä—É—á–∏–≤–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
- –ù–µ –±—ã–ª–æ –∑–∞—â–∏—Ç—ã –æ—Ç –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã —Å cooldown –ø–µ—Ä–∏–æ–¥–æ–º

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. ‚úÖ –ö–∞–∂–¥—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `post_views` (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
2. ‚úÖ –°—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
   - –≠—Ç–æ –ø–µ—Ä–≤—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
   - –ò–õ–ò –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ **60 –º–∏–Ω—É—Ç** —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
3. ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏ –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

### 1Ô∏è‚É£ –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –≤ Supabase SQL Editor

**–§–∞–π–ª:** `FIX_UNIQUE_POST_VIEWS.sql`

```sql
DROP FUNCTION IF EXISTS increment_post_views(uuid);

CREATE OR REPLACE FUNCTION increment_post_views(post_id uuid)
RETURNS json
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_user_id uuid;
  v_last_view_at timestamptz;
  v_cooldown_minutes integer := 60; -- 1 —á–∞—Å
  v_should_increment boolean := false;
  v_new_count integer;
BEGIN
  v_user_id := auth.uid();
  
  -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Å–º–æ—Ç—Ä
  SELECT viewed_at INTO v_last_view_at
  FROM post_views
  WHERE post_views.post_id = increment_post_views.post_id
    AND (
      (v_user_id IS NOT NULL AND post_views.user_id = v_user_id)
      OR (v_user_id IS NULL AND post_views.user_id IS NULL)
    )
  ORDER BY viewed_at DESC
  LIMIT 1;
  
  -- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å
  IF v_last_view_at IS NULL THEN
    v_should_increment := true;
  ELSIF (EXTRACT(EPOCH FROM (NOW() - v_last_view_at)) / 60) >= v_cooldown_minutes THEN
    v_should_increment := true;
  ELSE
    v_should_increment := false;
  END IF;
  
  -- –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
  INSERT INTO post_views (post_id, user_id, viewed_at)
  VALUES (increment_post_views.post_id, v_user_id, NOW());
  
  -- –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  IF v_should_increment THEN
    UPDATE posts 
    SET views = COALESCE(views, 0) + 1
    WHERE id = increment_post_views.post_id
    RETURNING views INTO v_new_count;
  ELSE
    SELECT views INTO v_new_count
    FROM posts
    WHERE id = increment_post_views.post_id;
  END IF;
  
  -- –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  RETURN json_build_object(
    'incremented', v_should_increment,
    'views', COALESCE(v_new_count, 0),
    'cooldown_minutes', v_cooldown_minutes
  );
END;
$$;

GRANT EXECUTE ON FUNCTION increment_post_views(uuid) TO authenticated;
GRANT EXECUTE ON FUNCTION increment_post_views(uuid) TO anon;
```

### 2Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
npm run dev
```

### 3Ô∏è‚É£ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Å—Ç** ‚Üí –í –∫–æ–Ω—Å–æ–ª–∏: `[Post Views] ‚úÖ Incremented to X`
2. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** ‚Üí –í –∫–æ–Ω—Å–æ–ª–∏: `[Post Views] üïê Cooldown (60min), current: X`
3. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ 1 —á–∞—Å –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–Ω–æ–≤–∞** ‚Üí –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Å—á–∏—Ç–∞–µ—Ç—Å—è

---

## üìä –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ

–§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON:

```json
{
  "incremented": true,
  "views": 42,
  "cooldown_minutes": 60
}
```

**–ü–æ–ª—è:**
- `incremented` - –±—ã–ª –ª–∏ —É–≤–µ–ª–∏—á–µ–Ω —Å—á–µ—Ç—á–∏–∫ (true/false)
- `views` - —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- `cooldown_minutes` - –ø–µ—Ä–∏–æ–¥ cooldown –≤ –º–∏–Ω—É—Ç–∞—Ö

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–∑–º–µ–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥ cooldown

–í SQL —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:
```sql
v_cooldown_minutes integer := 60; -- –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- `5` - 5 –º–∏–Ω—É—Ç (–º—è–≥–∫–∞—è –∑–∞—â–∏—Ç–∞, —É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- `60` - 1 —á–∞—Å (–±–∞–ª–∞–Ω—Å)
- `1440` - 24 —á–∞—Å–∞ (—Å—Ç—Ä–æ–≥–∞—è –∑–∞—â–∏—Ç–∞)

---

## üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ—Å—Ç–∞

```sql
SELECT 
  pv.viewed_at,
  pv.user_id,
  p.username
FROM post_views pv
LEFT JOIN profiles p ON p.id = pv.user_id
WHERE pv.post_id = 'YOUR_POST_ID'
ORDER BY pv.viewed_at DESC
LIMIT 100;
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```sql
SELECT 
  COUNT(*) as total_views,
  COUNT(DISTINCT post_id) as unique_posts
FROM post_views
WHERE user_id = 'USER_ID';
```

### –¢–æ–ø –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã—Ö –ø–æ—Å—Ç–æ–≤

```sql
SELECT 
  p.title,
  COUNT(*) as view_count
FROM post_views pv
JOIN posts p ON p.id = pv.post_id
GROUP BY p.id, p.title
ORDER BY view_count DESC
LIMIT 10;
```

---

## üîí –ó–∞—â–∏—Ç–∞

### –ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:
- ‚úÖ –ù–∞–∫—Ä—É—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –≤ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–∏–æ–¥
- ‚úÖ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–≤—ã—à–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- ‚ö†Ô∏è –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è (–≤—Å–µ —Å `user_id = NULL`)
- ‚ö†Ô∏è –°–º–µ–Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–æ–π—Ç–∏ –∑–∞—â–∏—Ç—É
- ‚ö†Ô∏è –î–ª—è —Å—Ç—Ä–æ–≥–æ–π –∑–∞—â–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ IP tracking (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

---

## üêõ Troubleshooting

### –°—á–µ—Ç—á–∏–∫ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
**–ü—Ä–æ–±–ª–µ–º–∞:** Cooldown –∞–∫—Ç–∏–≤–µ–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–æ–∂–¥–∏—Ç–µ 60 –º–∏–Ω—É—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –≤ SQL

### –û—à–∏–±–∫–∞: "function increment_post_views does not exist"
**–ü—Ä–æ–±–ª–µ–º–∞:** SQL –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ `FIX_UNIQUE_POST_VIEWS.sql`

### –ö–æ–Ω—Å–æ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç {}
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Ñ—É–Ω–∫—Ü–∏–∏  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é (DROP + CREATE)

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å IP –∞–¥—Ä–µ—Å–∞–º–∏ –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–π –∑–∞—â–∏—Ç—ã
- Cooldown –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º (—Ä–∞–∑–Ω—ã–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `post_views(post_id, user_id, viewed_at)`

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É 10 —Ä–∞–∑ ‚Üí 10 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
```

**–ü–æ—Å–ª–µ:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É 10 —Ä–∞–∑ ‚Üí 1 –ø—Ä–æ—Å–º–æ—Ç—Ä
–ß–µ—Ä–µ–∑ 1 —á–∞—Å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–Ω–æ–≤–∞ ‚Üí 2 –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
```

**–ß–µ—Å—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞!** üéØ
