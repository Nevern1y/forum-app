# üöÄ –§–ò–ù–ê–õ–¨–ù–û–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–ï: –í—Å–µ SQL –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üìã 4 SQL —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (5 –º–∏–Ω—É—Ç)

---

## 1Ô∏è‚É£ Reactions UNIQUE Constraint (–ö–†–ò–¢–ò–ß–ù–û!)

**–§–∞–π–ª:** `supabase/migrations/031_fix_reactions_constraint.sql`

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –°—Ç–∞—Ä—ã–π constraint: `UNIQUE(post_id, user_id, reaction_type)`
- –ü–æ–∑–≤–æ–ª—è–ª —Å—Ç–∞–≤–∏—Ç—å –ò like –ò dislike –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚ùå
- UPSERT –Ω–µ —Ä–∞–±–æ—Ç–∞–ª ‚ùå

**–†–µ—à–µ–Ω–∏–µ:**
- –ù–æ–≤—ã–π constraint: `UNIQUE(post_id, user_id)`  
- –û–¥–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–æ—Å—Ç ‚úÖ
- UPSERT —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –í–°–Å –∏–∑: supabase/migrations/031_fix_reactions_constraint.sql
-- –ò –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
DROP CONSTRAINT
DELETE (0-N rows)  -- –ï—Å–ª–∏ –±—ã–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã
ALTER TABLE
CREATE INDEX
```

---

## 2Ô∏è‚É£ Notification Triggers

**–§–∞–π–ª:** `supabase/migrations/030_add_notification_triggers.sql`

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç:**
- ‚úÖ –ê–≤—Ç–æ—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
- ‚úÖ –ê–≤—Ç–æ—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–≤–µ—Ç–∞—Ö
- ‚úÖ –ê–≤—Ç–æ—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ª–∞–π–∫–∞—Ö
- ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è @mentions
- ‚úÖ Cleanup —Å—Ç–∞—Ä—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –í–°–Å –∏–∑: supabase/migrations/030_add_notification_triggers.sql
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
CREATE FUNCTION (6 —Ä–∞–∑)
CREATE TRIGGER (3 —Ä–∞–∑–∞)
CREATE INDEX (3 —Ä–∞–∑–∞)
```

---

## 3Ô∏è‚É£ Unique Post Views (Anti-Cheat)

**–§–∞–π–ª:** `FIX_UNIQUE_POST_VIEWS.sql`

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç:**
- ‚úÖ Cooldown 60 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º–∏
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å –∞–Ω–æ–Ω–∏–º–∞–º–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –í–°–Å –∏–∑: FIX_UNIQUE_POST_VIEWS.sql
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ALTER TABLE (2 —Ä–∞–∑–∞)
CREATE FUNCTION
GRANT (2 —Ä–∞–∑–∞)
```

---

## 4Ô∏è‚É£ Realtime Replica Identity

**–§–∞–π–ª:** `FIX_ALL_REPLICA_IDENTITY.sql`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç:**
- ‚úÖ –£–±–∏—Ä–∞–µ—Ç –æ—à–∏–±–∫–∏ "mismatch"
- ‚úÖ –£–±–∏—Ä–∞–µ—Ç "timed out"
- ‚úÖ Realtime —Ä–∞–±–æ—Ç–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –í–°–Å –∏–∑: FIX_ALL_REPLICA_IDENTITY.sql
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ALTER TABLE (16 —Ä–∞–∑)
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### 1. Reactions UPSERT
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å constraint
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conrelid = 'post_reactions'::regclass
  AND contype = 'u';

-- –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: post_reactions_post_user_unique
```

### 2. Notification Triggers
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã
SELECT trigger_name
FROM information_schema.triggers
WHERE trigger_name LIKE '%notify%';

-- –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å 3 —Ç—Ä–∏–≥–≥–µ—Ä–∞:
-- on_comment_created_notify
-- on_comment_reply_notify
-- on_reaction_created_notify
```

### 3. View Function
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
SELECT proname
FROM pg_proc
WHERE proname = 'increment_post_views';

-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: increment_post_views
```

### 4. Replica Identity
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
SELECT 
  relname,
  CASE relreplident
    WHEN 'd' THEN '‚úÖ default'
    WHEN 'f' THEN '‚ùå full'
  END AS status
FROM pg_class
WHERE relname IN ('post_reactions', 'notifications', 'posts', 'comments')
ORDER BY relname;

-- –í—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å '‚úÖ default'
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### Test 1: Reactions (UPSERT)
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π –ø–æ—Å—Ç
2. –ü–æ—Å—Ç–∞–≤—å—Ç–µ –ª–∞–π–∫ ‚Üí ‚úÖ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. –ü–æ—Å—Ç–∞–≤—å—Ç–µ –¥–∏–∑–ª–∞–π–∫ ‚Üí ‚úÖ –º–µ–Ω—è–µ—Ç—Å—è —Å –ª–∞–π–∫–∞ –Ω–∞ –¥–∏–∑–ª–∞–π–∫
4. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Üí ‚úÖ –¥–∏–∑–ª–∞–π–∫ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è
5. –ö–æ–Ω—Å–æ–ª—å ‚Üí ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "no unique constraint"

### Test 2: Notifications
1. –û—Ç–∫—Ä–æ–π—Ç–µ 2 –±—Ä–∞—É–∑–µ—Ä–∞ (User A –∏ User B)
2. User B –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Å—Ç User A
3. User A –≤–∏–¥–∏—Ç:
   - ‚úÖ Toast "–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
   - ‚úÖ Badge –æ–±–Ω–æ–≤–∏–ª—Å—è (1)
   - ‚úÖ –í dropdown –µ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### Test 3: Views Anti-Cheat
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Å—Ç ‚Üí –ö–æ–Ω—Å–æ–ª—å: `‚úÖ Incremented to 42`
2. –û–±–Ω–æ–≤–∏—Ç–µ (F5) ‚Üí –ö–æ–Ω—Å–æ–ª—å: `üïê Cooldown (60min), current: 42`
3. ‚úÖ –°—á–µ—Ç—á–∏–∫ –ù–ï —É–≤–µ–ª–∏—á–∏–ª—Å—è

### Test 4: Realtime
1. –û—Ç–∫—Ä–æ–π—Ç–µ 2 –≤–∫–ª–∞–¥–∫–∏ —Å –æ–¥–Ω–∏–º –ø–æ—Å—Ç–æ–º
2. –í –ø–µ—Ä–≤–æ–π –ø–æ—Å—Ç–∞–≤—å—Ç–µ –ª–∞–π–∫
3. –í–æ –≤—Ç–æ—Ä–æ–π ‚Üí ‚úÖ –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–∏–ª—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
4. –ö–æ–Ω—Å–æ–ª—å ‚Üí ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "mismatch"

---

## üö® Troubleshooting

### "Constraint already exists"
**–†–µ—à–µ–Ω–∏–µ:** Constraint —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —à–∞–≥

### "Function already exists"  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤—å—Ç–µ `OR REPLACE` –≤ CREATE FUNCTION

### "No such table"
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
```sql
SELECT tablename FROM pg_tables WHERE schemaname = 'public';
```

### Realtime –≤—Å—ë –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. DevTools ‚Üí Network ‚Üí WS (websocket)
2. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è `postgres_changes`
3. –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ replica_identity –µ—â—ë —Ä–∞–∑

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–í—Å–µ–≥–æ –∫–æ–º–º–∏—Ç–æ–≤:** 62  
**SQL —Å–∫—Ä–∏–ø—Ç–æ–≤:** 4  
**–§—É–Ω–∫—Ü–∏–π —Å–æ–∑–¥–∞–Ω–æ:** 7  
**–¢—Ä–∏–≥–≥–µ—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:** 3  
**–¢–∞–±–ª–∏—Ü –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 17

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### Reactions:
- ‚úÖ UPSERT —Ä–∞–±–æ—Ç–∞–µ—Ç (–ª–∞–π–∫ ‚Üî –¥–∏–∑–ª–∞–π–∫)
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ä–µ–∞–∫—Ü–∏–π
- ‚úÖ –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–æ—Å—Ç

### Notifications:
- ‚úÖ –ê–≤—Ç–æ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
- ‚úÖ –ê–≤—Ç–æ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–≤–µ—Ç–∞—Ö  
- ‚úÖ –ê–≤—Ç–æ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ª–∞–π–∫–∞—Ö
- ‚úÖ Realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### Views:
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏ (60 –º–∏–Ω cooldown)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –∞–Ω–æ–Ω–∏–º–æ–≤

### Realtime:
- ‚úÖ –ë–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

---

## ‚è±Ô∏è –í—Ä–µ–º—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

**–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
1. Reactions constraint (1 –º–∏–Ω)
2. Notification triggers (1 –º–∏–Ω)
3. Unique views (1 –º–∏–Ω)
4. Replica identity (1 –º–∏–Ω)

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 4 –º–∏–Ω—É—Ç—ã  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–†–∏—Å–∫–∏:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (–≤—Å—ë –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ)

---

## üéâ –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev server
npm run dev
```

**–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å:**
- ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–º–∏ —Ä–µ–∞–∫—Ü–∏—è–º–∏ –±–µ–∑ –æ—à–∏–±–æ–∫
- üîî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
- üõ°Ô∏è –ó–∞—â–∏—â–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º–∏
- ‚ö° Realtime –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –∫ production!** üöÄ
