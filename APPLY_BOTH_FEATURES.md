# üöÄ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï: –ü–æ–¥–ø–∏—Å–∫–∏ + –ü–æ–∏—Å–∫ (–û–±–µ —á–∞—Å—Ç–∏)

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ß–ê–°–¢–¨ 1: –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ (1.5 —á–∞—Å–∞)
- ‚úÖ SQL –º–∏–≥—Ä–∞—Ü–∏—è 032
- ‚úÖ Follow/Unfollow –∫–Ω–æ–ø–∫–∞
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞ /following
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞—Ö
- ‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### –ß–ê–°–¢–¨ 2: Full-Text Search (1 —á–∞—Å)
- ‚úÖ SQL –º–∏–≥—Ä–∞—Ü–∏—è 033
- ‚úÖ Search API —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- ‚úÖ SearchBar —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞

---

## üîß –ü–†–ò–ú–ï–ù–ï–ù–ò–ï (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ ‚úÖ DONE

**–í—ã —É–∂–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏:**
```sql
supabase/migrations/032_add_subscriptions_system.sql
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –¥–ª—è –ø–æ–∏—Å–∫–∞

**–û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor:**

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –í–ï–°–¨ —Ñ–∞–π–ª:
supabase/migrations/033_add_full_text_search.sql

-- –ù–∞–∂–º–∏—Ç–µ Run
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ALTER TABLE (2x) - –¥–æ–±–∞–≤–ª–µ–Ω—ã ts_vector –∫–æ–ª–æ–Ω–∫–∏
CREATE INDEX (4x) - GIN indexes –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE FUNCTION (5x) - —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞
CREATE TRIGGER (2x) - –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ search_vector
UPDATE (2x) - –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
‚úÖ Success!
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-30 —Å–µ–∫—É–Ω–¥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Å—Ç–æ–≤)

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
npm run dev
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ß–ê–°–¢–¨ 1: –ü–æ–¥–ø–∏—Å–∫–∏ ‚úÖ

**Test 1: Follow button**
1. –û—Ç–∫—Ä–æ–π—Ç–µ —á—É–∂–æ–π –ø—Ä–æ—Ñ–∏–ª—å
2. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è"
3. ‚úÖ Toast: "–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!"
4. ‚úÖ –ö–Ω–æ–ø–∫–∞ ‚Üí "–û—Ç–ø–∏—Å–∞—Ç—å—Å—è"

**Test 2: –õ–µ–Ω—Ç–∞ /following**
1. –û—Ç–∫—Ä–æ–π—Ç–µ `/following` (–∏–∫–æ–Ω–∫–∞ Users –≤ navbar)
2. ‚úÖ –í–∏–¥–Ω—ã –ø–æ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –æ—Ç –ø–æ–¥–ø–∏—Å–æ–∫
3. ‚úÖ Empty state –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫

---

### –ß–ê–°–¢–¨ 2: –ü–æ–∏—Å–∫

**Test 1: SearchBar**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ–∏—Å–∫–æ–º
2. –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≤ SearchBar
3. ‚úÖ –ü–æ—è–≤–ª—è–µ—Ç—Å—è dropdown —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
4. ‚úÖ –í–∏–¥–Ω—ã: –ø–æ—Å—Ç—ã, —Ç–µ–≥–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
5. ‚úÖ –ü—Ä–∏ Enter ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ /search?q=...

**Test 2: –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ**
1. –í–≤–µ–¥–∏—Ç–µ 2 –±—É–∫–≤—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä "—Ä–µ")
2. ‚úÖ –ß–µ—Ä–µ–∑ 300ms –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
3. ‚úÖ –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
4. ‚úÖ –°—á–µ—Ç—á–∏–∫–∏ (views, reputation, usage)

**Test 3: –ò—Å—Ç–æ—Ä–∏—è**
1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∏—Å–∫–æ–≤
2. –û—á–∏—Å—Ç–∏—Ç–µ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ
4. ‚úÖ –ü–æ—è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è (max 5)
5. ‚úÖ –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç

**Test 4: Keyboard navigation**
1. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‚Üì‚Üë –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
3. ‚úÖ –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–π
4. Enter ‚Üí –≤—ã–±–æ—Ä
5. Esc ‚Üí –∑–∞–∫—Ä—ã—Ç–∏–µ

**Test 5: SQL Full-Text Search**
–û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor:

```sql
-- Test 1: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫
SELECT * FROM search_posts('javascript', NULL, NULL, NULL, NULL, 'relevance', 10, 0);

-- Test 2: –ü–æ–∏—Å–∫ —Å —Ç–µ–≥–æ–º
SELECT * FROM search_posts('react', 'javascript', NULL, NULL, NULL, 'recent', 10, 0);

-- Test 3: –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT * FROM search_users('john', 10);

-- Test 4: –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
SELECT * FROM get_search_suggestions('java', 5);
```

---

## üìä –ß—Ç–æ –¥–∞–µ—Ç Full-Text Search?

### Performance
**–î–æ (ILIKE):**
```sql
WHERE title ILIKE '%javascript%' OR content ILIKE '%javascript%'
-- –í—Ä–µ–º—è: ~100-500ms –Ω–∞ 10,000 –ø–æ—Å—Ç–æ–≤
-- –ü—Ä–æ–±–ª–µ–º–∞: Full table scan!
```

**–ü–æ—Å–ª–µ (GIN + ts_vector):**
```sql
WHERE search_vector @@ plainto_tsquery('javascript')
-- –í—Ä–µ–º—è: ~5-20ms –Ω–∞ 10,000 –ø–æ—Å—Ç–æ–≤
-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: 10-100x –±—ã—Å—Ç—Ä–µ–µ! üöÄ
```

### Features

**1. Weighted search**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ (weight A) –≤–∞–∂–Ω–µ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è (weight B)
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

**2. Russian language support**
- –°—Ç–µ–º–º–∏–Ω–≥ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç–∫)
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ø-—Å–ª–æ–≤ (–∏, –≤, –Ω–∞)
- –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

**3. Multiple filters**
- –ü–æ —Ç–µ–≥–∞–º
- –ü–æ –∞–≤—Ç–æ—Ä—É
- –ü–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: relevance/recent/popular

**4. Smart suggestions**
- –¢–æ–ø-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- 3 —Ç–∏–ø–∞: –ø–æ—Å—Ç—ã, —Ç–µ–≥–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- –ü–æ–∫–∞–∑ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (—Å—á–µ—Ç—á–∏–∫–∏)

---

## üóÑÔ∏è Database Changes

### –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏:
```sql
posts.search_vector       -- tsvector (GIN indexed)
profiles.search_vector    -- tsvector (GIN indexed)
```

### –ù–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã (4):
```sql
idx_posts_search_vector       -- GIN –¥–ª—è fast search
idx_profiles_search_vector    -- GIN –¥–ª—è user search
idx_posts_created_at_desc     -- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
idx_posts_author_created      -- –§–∏–ª—å—Ç—Ä –ø–æ –∞–≤—Ç–æ—Ä—É
```

### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (5):
```sql
update_posts_search_vector()      -- Trigger function
update_profiles_search_vector()   -- Trigger function
search_posts()                    -- Main search RPC
search_users()                    -- User search RPC
get_search_suggestions()          -- Autocomplete RPC
```

### –ù–æ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (2):
```sql
trigger_update_posts_search_vector    -- Auto-update on INSERT/UPDATE
trigger_update_profiles_search_vector -- Auto-update on INSERT/UPDATE
```

---

## üéØ API Usage Examples

### JavaScript/TypeScript:

```typescript
import { searchPosts, searchUsers, getSearchSuggestions } from '@/lib/api/search'

// 1. Basic search
const posts = await searchPosts({ query: 'javascript' })

// 2. Search with filters
const filtered = await searchPosts({
  query: 'react hooks',
  tag: 'javascript',
  sortBy: 'recent',
  pageSize: 20,
  pageOffset: 0
})

// 3. Search users
const users = await searchUsers('john', 10)

// 4. Get autocomplete
const suggestions = await getSearchSuggestions('java', 5)

// 5. History (localStorage)
import { saveSearchHistory, getSearchHistory } from '@/lib/api/search'

saveSearchHistory('javascript tutorial')
const history = getSearchHistory() // ['javascript tutorial', ...]
```

---

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "column search_vector does not exist"
**–ü—Ä–∏—á–∏–Ω–∞:** SQL –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ 033_add_full_text_search.sql

### –ü–æ–∏—Å–∫ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ search_vector –∑–∞–ø–æ–ª–Ω–µ–Ω
SELECT id, title, search_vector 
FROM posts 
WHERE search_vector IS NOT NULL 
LIMIT 5;

-- –ï—Å–ª–∏ –ø—É—Å—Ç–æ:
UPDATE posts SET search_vector = 
  setweight(to_tsvector('russian', COALESCE(title, '')), 'A') ||
  setweight(to_tsvector('russian', COALESCE(content, '')), 'B');
```

### –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤:**
```sql
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'posts' 
  AND indexname LIKE '%search%';

-- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: idx_posts_search_vector (GIN)
```

### –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Console
2. –í–≤–µ–¥–∏—Ç–µ –≤ –ø–æ–∏—Å–∫ 2+ —Å–∏–º–≤–æ–ª–∞
3. –°–º–æ—Ç—Ä–∏—Ç–µ Network tab
4. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ RPC `get_search_suggestions`

---

## ‚úÖ Checklist

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

### –ü–æ–¥–ø–∏—Å–∫–∏:
- [ ] ‚úÖ SQL 032 –ø—Ä–∏–º–µ–Ω–µ–Ω
- [ ] ‚úÖ Follow –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] ‚úÖ /following –ª–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö
- [ ] ‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### –ü–æ–∏—Å–∫:
- [ ] ‚úÖ SQL 033 –ø—Ä–∏–º–µ–Ω–µ–Ω
- [ ] ‚úÖ ts_vector –∫–æ–ª–æ–Ω–∫–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] ‚úÖ GIN –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] ‚úÖ SearchBar –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç suggestions
- [ ] ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- [ ] ‚úÖ Keyboard navigation —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] ‚úÖ SQL search_posts() —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìà Statistics

### –ö–æ–¥:
- **–ö–æ–º–º–∏—Ç–æ–≤:** 11
- **SQL –º–∏–≥—Ä–∞—Ü–∏–π:** 2 (032 + 033)
- **API —Ñ—É–Ω–∫—Ü–∏–π:** 11
- **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:** 7
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~1500

### –í—Ä–µ–º—è:
- **–ß–ê–°–¢–¨ 1 (–ü–æ–¥–ø–∏—Å–∫–∏):** 1.5 —á–∞—Å–∞
- **–ß–ê–°–¢–¨ 2 (–ü–æ–∏—Å–∫):** 1 —á–∞—Å
- **–í—Å–µ–≥–æ:** 2.5 —á–∞—Å–∞

### Features:
- ‚úÖ Follow/Unfollow —Å–∏—Å—Ç–µ–º–∞
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞
- ‚úÖ Full-Text Search (PostgreSQL)
- ‚úÖ –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
- ‚úÖ –§–∏–ª—å—Ç—Ä—ã (—Ç–µ–≥–∏, –∞–≤—Ç–æ—Ä, –¥–∞—Ç—ã)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞
- ‚úÖ Keyboard navigation
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## üéâ –ì–æ—Ç–æ–≤–æ!

**–û–±–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ production!**

**–°–ª–µ–¥—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**

### –ü–æ–¥–ø–∏—Å–∫–∏:
1. üìã –ú–æ–¥–∞–ª–∫–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º Followers/Following
2. üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞—Ö –æ—Ç –ø–æ–¥–ø–∏—Å–æ–∫
3. üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ü–æ–∏—Å–∫:
1. üìÑ –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ /search —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
2. üé® SearchFilters UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
3. üì± –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∏—Å–∫–∞
4. üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–í—Ä–µ–º—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:** 5 –º–∏–Ω—É—Ç  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Production-ready! ‚úÖ
